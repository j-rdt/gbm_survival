---
title: "GBM Survival Epistasis"
author: "Jonathan Arditi"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning=FALSE, 
                      message=F)
```

## What are we doing here?

I thought it would be beneficial to work and create results in a more narrative format - this helps me think linearly about the analyses and remember why I did each step, as well as helps everyone I try to explain it to understand my workflow.

After some reflection I realized there are two central questions we are trying to answer in a multivariate analysis:

1.  Does having 2 comorbidities confer disproportionately worse survival than having just one of those comorbidities? *For example, is having obesity and Afib unexpectedly bad compared to just having obesityor just having Afib?*

2.  Does that effect disappear in the presence of other comorbidities or patient statistics? *For example, does the obesity+Afib relationship disappear in the presence of age or HTN? Is the observed relationship just coincidentally capturing the same population as another condition, or is it truly unique?*

The idea of an underlying factor having variable effects depending on other factors in the background is called **epistasis** (yet another concept I freely borrow from genomics). To me this provides a concrete, testable way to think about what "multivariate effects" actually look like.

I answer question 1) by comparing survival of patients with 2 comorbidities to survival of patients with just 1 and with 0 comorbidities. I performed univariate Cox regression on each combination using 0 comorbidities as the reference level for the hazard, and verified the findings with survival curves.

I answer question 2) by running those comorbidities in multivariate Cox regression against known confounders like age, BMI, MGMT, IDH, etc to see if they maintain significance in the presence of these known or suspected prognosticators. That's not done yet though, so we'll look at that next week.

```{r libraries-setup, include=FALSE, message=FALSE}
source("E:/Rwd/GBMSurvey/GBM_survey_quickload.R")
rm(list=setdiff(ls(), c("ci", "basic", "trt")))
library(igraph)
library(psych)
library(survivalAnalysis)
library(ggsurvfit)
source("E:/Rwd/res/center_igraph_edges.R")
source("E:/Rwd/res/num-to-colors.R")

ci<-ci[!names(ci)=="other"]
sums<-sapply(3:138, function(x){sum(ci[x]=="YES")})
names(sums)<-colnames(ci)[3:138]
sums20<-sums[sums>25] # why
ll<-length(sums20)
sums20<-sums20[order(names(sums20))]
ci20<-ci[colnames(ci) %in% names(sums20)]
ci20<-ci20[order(names(ci20))]
ci20<-ci20[order(sums20, decreasing = T)]
sums20<-sums20[order(sums20, decreasing = T)]

surv20<-cbind(basic[2:3], ci20)

#rm(ci)
```

## The data

We collected data on 138 unique comorbidities (excluding the "other" category), but many of them have very few patients. I generated a network showing interactions of comorbidities with at least 25 patients, then filtered for interactions with log-rank p \< 0.05 (from cox regression) and at least 12 patients in each interaction subgroup. I scored each interaction by the magnitude of the combined hazard ratio relative to the hazards of the individual conditions (I call it the "relative detriment").

```{r filter-network, message=F, fig.width=8, fig.height=8}
subset.make<-function(data, ...){
  out<-data[c(...)]
  out
}

subset.find<-function(data, stri){
  which(str_detect(colnames(data), str_replace(stri, " & ", "|")))
}

subset.diff<-function(data, ..., print=F, method="disproportionality"){
  #if greater = T, this function will calculate the difference in median survival 
  # between the group with BOTH conditions and the single-condition group with the greater survival.
  # if great = F it does the same calculation with the single-condition group with the lesser survival
  # if greater = "both", calculate both and multiply them
  #subs<-subset.make(data, subset.find(data, ...))
  subs<-subset.make(data, ...)
  name<-str_flatten(colnames(subs),collapse=" & ")
  notNA<-apply(is.na(subs), 1, any)
  subs<-subs[!notNA,]
  data2<-unite(subs, name)
  subs<-cbind(data[!notNA,1:2],data2)
  colnames(subs)[1:2]<-c("Vital.Status", "Survival.Months")
  medians<-aggregate(Survival.Months ~ name, subs, median)
  counts<-table(subs$name)
  form<-paste("Survival.Months + Vital Status", "name", sep=" ~ ")
  #test<-kruskal.test(formula(form), data=as.matrix(subs))
  #kruskal.p<-test$p.value
  test<-analyse_survival(subs, 
                 vars(Survival.Months, Vital.Status), 
                 by=name, 
                 cox_reference_level = "NO_NO")
  logrank.p<-pluck_survival_analysis(test,"p")
  if (logrank.p>=0.05){
    return(0)
  } else if (any(counts<12)){
    return(0)
  } else if (length(medians[[2]])<4) {
    if(print) print(paste("Length less than 4: ", ...))
    return(0)
  } else {
    #both<-medians$Survival.Months[medians$name=="YES_YES"]
    #ny<-medians$Survival.Months[medians$name=="NO_YES"]
    #yn<-medians$Survival.Months[medians$name=="YES_NO"]
    #dyn<-yn-both
    #dny<-ny-both
    coefs<-exp(test$coxph$coefficients)
    HRyy<-coefs[which(str_detect(names(coefs), "YES_YES"))]
    HRyn<-coefs[which(str_detect(names(coefs), "YES_NO"))]
    HRny<-coefs[which(str_detect(names(coefs), "NO_YES"))]
    if(method=="relative-detriment") return(round(unname(HRyy/harmonic.mean(c(HRny,HRyn))), digits=2))
    if (method=="disproportionality") return(round(HRyy-HRyn-HRny, digits=2))
  }
}

adj<-sapply(3:(ll+2), function(x){sapply(3:(ll+2), function(y){subset.diff(surv20,x,y, method="relative-detriment")})})
colnames(adj)<-colnames(ci20)

network<-graph_from_adjacency_matrix(adj, mode="undirected", diag=F, weighted=T, add.colnames = T)


plot(network, rescale=F, layout=layout.circle, 
        vertex.label=paste(names(sums20), sums20, sep="\n"),
        vertex.size=logb(sums20, b=2), 
        edge.label=E(network)$weight, 
        edge.color=num_to_rb(E(network)$weight, 
                             min(E(network)$weight), 
                             max(E(network)$weight)),
        edge.label.color=num_to_rb(E(network)$weight, 
                                   min(E(network)$weight), 
                                   max(E(network)$weight)),
#        edge.label.x=center_igraph_edges(network, "x"),
#        edge.label.y=center_igraph_edges(network, "y"),
        vertex.label.cex=0.5,
        edge.label.cex=0.4,
        ylim=c(-1,1), xlim=c(-1,1), asp=0
)

edgesByWeight<-as_edgelist(network)[order(E(network)$weight, decreasing = T),]
edgesRanked<-apply(edgesByWeight, c(1,2), function(x){names(ci20)[x]})
edgesRanked<-cbind(edgesRanked, E(network)$weight[order(E(network)$weight, decreasing = T)])
```

I colored the edges by that score, so red means the comorbidities are WAY worse in combo than they are individually, while blue means there is not a big difference between individual hazards and combined hazards.

## Methods: Question 1

We can examine these relationships more exactly with cox plots and survival curves. (add cox plot function here).

```{r survplot, message=F, fig.width=8, fig.height=6}
subset.plot<-function(data, ..., save=F, print=T){
  subs<-subset.make(data, subset.find(data, ...))
  name<-str_flatten(colnames(subs),collapse=" & ")
  notNA<-apply(is.na(subs), 1, any)
  subs<-subs[!notNA,]
  data2<-unite(subs, name)
  subs<-cbind(data[!notNA,2],data2)
  colnames(subs)[1]<-"Survival.Months"
  medians<-aggregate(Survival.Months ~ name, subs, median)
  
  groups<-length(medians[[2]])
  counts<-aggregate(Survival.Months ~ name, subs, length)
  medians[[2]]<-paste("md=",round(medians[[2]], digits=1),"\n n=",counts[[2]],sep="")
  name2<-str_replace(name, " & ", "_")
  form<-paste("Survival.Months", "name", sep=" ~ ")
  test<-kruskal.test(formula(form), data=as.matrix(subs))
  kruskal.p<-test$p.value
  title<-paste("Grouped Survival:", name, "\n kruskal.p =", signif(kruskal.p, digits = 3))
  p<-ggplot(subs, aes(x=name, y=Survival.Months)) + 
    geom_boxplot() +
    stat_summary(fun=mean, geom="point", shape=8, size=1) + 
    geom_text(data = medians, aes(label = Survival.Months, y = -10)) +
    labs(title=title, x=name) +
    theme_classic()
  #name2<-str_replace(name, " & ", "_")
  if (save) {ggsave(paste(name2, "box.jpg", sep="_"), p, "jpeg")}
  if(print) {p}
}

survplotcombn<-function(data, groups=4, ...){
  covs<-c(...)
  #return(covs)
  #stop()
  flatcovs<-str_flatten(covs, collapse=" & ")
  #return(flatcovs)
  #stop()
  subs<-subset.make(data, subset.find(data, flatcovs))
  name<-flatcovs
  notNA<-apply(is.na(subs), 1, any)
  subs<-subs[!notNA,]
  data2<-unite(subs, name)
  subs<-cbind(data[!notNA,1:2],data2)
  #colnames(subs)[1:2]<-c("Survival.Months", "Vital.Status")
  
  form<-formula(paste("Surv(Survival.Months, Vital.Status) ~", "name"))
  test2<-do.call(survfit2, args=list(formula=form, data=subs))
  
  lens<-test2$strata
  x<-test2$time[1:lens[1]]
  y<-test2$time[(lens[1]+1):length(test2$time)]
  ll<-min(lens)
  # Tick function/Parameters 6 interval
  ticks<-0:37*12 #(start,end,how many ticks inclusive from start to end)
  #ticks_mgmt = linspace(0, 210, 36) #(start,end,how many ticks inclusive from start to end)
  ticks_str<-paste(ticks)
  minorInds<-which(ticks %% 12 != 0) #Ticks on how many interval
  ticks_str[minorInds]<-""
  
  tbls<-table(subs$name)
  labels<-lapply(1:length(tbls), function(i){paste(names(tbls[i]), tbls[i], sep=", n=")})
  
  #labels<-lapply()
  
  if(groups==2){palette<-c("red", "blue")}else if (groups==4){palette<-c("red", "blue", "green2", "black")}
  
  obj<-survminer::ggsurvplot(test2, 
                  xlim=c(0, 204), 
                  break.x.by = 6, 
                  ylab="Fraction Surviving",
                  xlab="Months",
                  conf.int = TRUE,
                  pval= T,  
                  pval.coord=c(100,.25),
                  pval.size=3,
                  #risk.table = T, risk.table.title="",
                  legend.labs=unlist(labels), 
                  legend.title="",  
                  surv.scale = "percent", palette=palette,
                  #title=paste("Survival:", covars, "| Proportional=", verdict)
                  title=paste("Survival:", str_flatten(covs, collapse=" + ")))
  p<-obj$plot+
    theme_classic()+
    theme(legend.text = element_text(size = 14))+
    theme(plot.title = element_text(hjust = 0.5, size=16))+
    guides(colour = guide_legend(nrow = 2))+
    theme(legend.position = c(.60, 0.75))+
    theme(axis.title.x =element_text(size = 12))+
    theme(axis.title.y = element_text(size = 12))+
    theme(axis.text.x =  element_text(size=8))+
    theme(axis.text.y =  element_text(size=8))+
    guides(color = guide_legend(override.aes = list(shape=NA)))+
    scale_x_continuous(breaks=ticks, labels=ticks_str)
  return(p)
}
survplotcombn(surv20, 4, "obesity", "Afib")
```

I did this for every combination on the network graph and verified with cox plots.

```{r, message=F, fig.width=8, fig.height=3}
fastcox<-function(all_pcomorbs_vec){
  all_pcomorbs_n<-c(HTN="Hyptertension", 
                  HLD="Hyperlipidemia", 
                  obesity="Obesity", 
                  GERD="GERD", 
                  Diabetes="Diabetes", 
                  osteoarthritis="Osteoarthritis", 
                  Depression="Depression", 
                  CAD="CAD",
                  Hypothyroidism="Hypothyroidism", 
                  BPH="BPH", 
                  Afib="Afib", 
                  Asthma="Asthma", 
                  sleep.apnea="Sleep Apnea", 
                  Stroke="Stroke", 
                  tobacco.use.disorder="Tobacco Use Dis.",
                  COPD="COPD",
                  gout="Gout",
                  nephrolithiasis="Nephrolithiasis",
                  MI="MI",
                  CKD="CKD",
                  alcohol.use.disorder="Alcohol Use Dis.",
                  dysrhythmia="Dysrhythmia"
                  )
  fac_ref<-c(HTN="NO", 
           HLD="NO", 
           obesity="NO", 
           GERD="NO", 
           Diabetes="NO", 
           osteoarthritis="NO", 
           Depression="NO", 
           CAD="NO",
           Hypothyroidism="NO", 
           BPH="NO", 
           Afib="NO", 
           Asthma="NO", 
           sleep.apnea="NO", 
           Stroke="NO", 
           tobacco.use.disorder="NO",
           COPD="NO",
           gout="NO",
           nephrolithiasis="NO",
           MI="NO",
           CKD="NO",
           alcohol.use.disorder="NO",
           dysrhythmia="NO"
          )
  purrr::map(sapply(all_pcomorbs_vec, function(x){expr(!!x)}), function(by)
{
  analyse_multivariate(surv20,
                       vars(Survival.Months, Vital.Status),
                       covariates = list(by), # covariates expects a list
                       covariate_name_dict = all_pcomorbs_n,
                       reference_level_dict = fac_ref)
}) %>%
  forest_plot(factor_labeller = all_pcomorbs_n,
              endpoint_labeller = c(Survival.Months="Survival Months"),
              orderer = ~order(abs(log(HR)), decreasing = T),
              labels_displayed = c("endpoint","factor", "n"),
              ggtheme = ggplot2::theme_bw(base_size = 10))
  
}
fastpaircox<-function(data, ...){
  
  covs<-c(...)
  #return(covs)
  #stop()
  flatcovs<-str_flatten(covs, collapse=" & ")
  #return(flatcovs)
  #stop()
  subs<-subset.make(data, subset.find(data, flatcovs))
  name<-flatcovs
  notNA<-apply(is.na(subs), 1, any)
  subs<-subs[!notNA,]
  data2<-unite(subs, name)
  subs<-cbind(data[!notNA,1:2],data2)
  
  all_pcomorbs_n<-c(name="group"
                  )
  all_pcomorbs<-c(name="name"
                  )
  fac_ref<-c(name="NO_NO"
          )
  purrr::map(sapply(all_pcomorbs, function(x){expr(!!x)}), function(by)
{
  analyse_multivariate(subs,
                       vars(Survival.Months, Vital.Status),
                       covariates = list(by), # covariates expects a list
                       covariate_name_dict = all_pcomorbs_n,
                       reference_level_dict = fac_ref)
}) %>%
  forest_plot(factor_labeller = all_pcomorbs_n,
              endpoint_labeller = c(Survival.Months="Survival Months"),
              orderer = ~order(abs(log(HR)), decreasing = T),
              labels_displayed = c("endpoint","factor"),
              ggtheme = ggplot2::theme_bw(base_size = 10), 
              title=name
              )
  
}
#fastcox(c(obesity="obesity", Afib="Afib"))
fastpaircox(surv20, "obesity", "Afib")
```

## Interesting Findings

Obesity and afib showed the most extreme combined effect:

```{r, fig.width=8, fig.height=8}
survplotcombn(surv20, 4, "obesity", "Afib")
```

```{r, fig.width=8, fig.height=3}
fastpaircox(surv20, "obesity", "Afib")
```

Among the top effects, osteoarthritis showed up frequently as worsening the effect of other conditions:

```{r, fig.width=8, fig.height=6}
survplotcombn(surv20, 4, "osteoarthritis", "CAD")
```

```{r, fig.width=8, fig.height=3}
fastpaircox(surv20, "osteoarthritis", "CAD")
```

```{r, fig.width=8, fig.height=6}
survplotcombn(surv20, 4, "GERD", "osteoarthritis")
```

```{r, fig.width=8, fig.height=3}
fastpaircox(surv20, "GERD", "osteoarthritis")
```

```{r, fig.width=8, fig.height=6}
survplotcombn(surv20, 4, "osteoarthritis", "Depression")
```

```{r, fig.width=8, fig.height=3}
fastpaircox(surv20, "osteoarthritis", "Depression")
```

As we have seen before, hypertension significantly impacts survival, but other common conditions don't, both on their own and in combination with hypertension.

```{r, fig.width=8, fig.height=6}
survplotcombn(surv20, 4, "HTN", "HLD")
```

```{r, fig.width=8, fig.height=3}
fastpaircox(surv20, "HTN", "HLD")
```

```{r, fig.width=8, fig.height=6}
survplotcombn(surv20, 4, "HTN", "Diabetes")
```

```{r, fig.width=8, fig.height=3}
fastpaircox(surv20, "HTN", "Diabetes")
```

Finally, we continue to see the bizarre trend that HLD slightly abrogates the effects of other comorbidities. (BPH is Benign Prostatic Hyperplasia.)

```{r, fig.width=8, fig.height=6}
survplotcombn(surv20, 4, "HLD", "CAD")
```

```{r, fig.width=8, fig.height=3}
fastpaircox(surv20, "HLD", "CAD")
```

```{r, fig.width=8, fig.height=6}
survplotcombn(surv20, 4, "HLD", "BPH")
```

```{r, fig.width=8, fig.height=3}
fastpaircox(surv20, "HLD", "BPH")
```
